#!/usr/bin/env bash

set -e

# Check if script is being sourced or executed
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  SCRIPT_EXECUTED=true
else
  SCRIPT_EXECUTED=false
fi

check_deps() {
  local missing_deps=()

  command -v fzf >/dev/null 2>&1 || missing_deps+=("fzf")
  command -v jq >/dev/null 2>&1 || missing_deps+=("jq")
  command -v osascript >/dev/null 2>&1 || missing_deps+=("osascript")
  command -v zellij >/dev/null 2>&1 || missing_deps+=("zellij")

  if [[ ${#missing_deps[@]} -gt 0 ]]; then
    echo "âŒ Missing required dependencies: ${missing_deps[*]}" >&2
    exit 1
  fi
}

declare -A GHOSTTY_THEMES=(
  [moon]="Tokyo Moon"
  [storm]="Tokyo Storm"
  [night]="Tokyo Night"
)

declare -A BAT_THEMES=(
  [moon]="Tokyo Moon"
  [storm]="Tokyo Storm"
  [night]="Tokyo Night"
)

declare -A ZELLIJ_THEMES=(
  [moon]="tokyo_moon"
  [storm]="tokyo_storm"
  [night]="tokyo_night"
)

declare -A DELTA_FEATURES=(
  [moon]="tokyo-moon"
  [storm]="tokyo-storm"
  [night]="tokyo-night"
)

declare -A VSCODE_THEMES=(
  [moon]="Moonlight II Italic"
  [storm]="Tokyo Night Storm"
  [night]="Tokyo Night"
)

declare -A WALLPAPERS=(
  [moon]="Wallpaper 13.jpg"
  [storm]="Wallpaper 06.jpg"
  [night]="Wallpaper 10.jpg"
)

set_ghostty_mood() {
  local mood="$1"
  local ghostty_theme="${GHOSTTY_THEMES[$mood]:-${GHOSTTY_THEMES[night]}}"
  local config_file="$DOTFILES/config/ghostty/config"

  if [[ ! -f "$config_file" ]]; then
    echo "âŒ Ghostty config file not found: $config_file" >&2
    return 1
  fi

  sed -i '' "s/^theme *=.*\"/theme=\"$ghostty_theme\"/" "$config_file"
  osascript "$DOTFILES/config/ghostty/reload-config.scpt" 2>/dev/null || true
  echo "âœ“ Updated Ghostty theme to: $ghostty_theme"
}

set_bat_mood() {
  local mood="$1"
  local bat_theme="${BAT_THEMES[$mood]:-${BAT_THEMES[night]}}"
  local config_file="$DOTFILES/config/bat/config"

  if [[ ! -f "$config_file" ]]; then
    echo "âŒ Bat config file not found: $config_file" >&2
    return 1
  fi

  sed -i '' "s/^--theme=.*\"/--theme=\"$bat_theme\"/" "$config_file"
  osascript "$DOTFILES/config/ghostty/reload-config.scpt" 2>/dev/null || true
  echo "âœ“ Updated Bat theme to: $bat_theme"
}

set_zellij_mood() {
  local mood="$1"
  local zellij_theme="${ZELLIJ_THEMES[$mood]:-${ZELLIJ_THEMES[night]}}"
  local config_file="$DOTFILES/config/zellij/config.kdl"

  if [[ ! -f "$config_file" ]]; then
    echo "âŒ Zellij config file not found: $config_file" >&2
    return 1
  fi

  sed -i '' "s/^theme \".*\"/theme \"$zellij_theme\"/" "$config_file"
  zellij kill-all-sessions --yes &> /dev/null || true
  echo "âœ“ Updated Zellij theme to: $zellij_theme"
}

set_delta_mood() {
  local mood="$1"
  local delta_features="${DELTA_FEATURES[$mood]:-${DELTA_FEATURES[night]}}"
  local config_file="$DOTFILES/git/.gitconfig"

  if [[ ! -f "$config_file" ]]; then
    echo "âŒ Git config file not found: $config_file" >&2
    return 1
  fi

  sed -i '' "s/^  features = .*/  features = \"$delta_features\"/" "$config_file"
  echo "âœ“ Updated Delta features to: $delta_features"
}

set_vscode_mood() {
  local mood="$1"
  local vscode_theme="${VSCODE_THEMES[$mood]:-${VSCODE_THEMES[night]}}"
  local vscode_settings="$HOME/Library/Application Support/Code/User/settings.json"

  if [[ ! -f "$vscode_settings" ]]; then
    echo "âŒ VS Code settings file not found: $vscode_settings" >&2
    return 1
  fi

  echo "Updating VS Code theme to: $vscode_theme"

  jq --arg theme "$vscode_theme" '.["workbench.colorTheme"] = $theme' "$vscode_settings" > "$vscode_settings.tmp" && mv "$vscode_settings.tmp" "$vscode_settings"
  echo "âœ“ Updated VS Code theme to: $vscode_theme"
}

set_mood_wallpaper() {
  local mood="$1"
  local mod_wallpaper="${WALLPAPERS[$mood]:-${WALLPAPERS[night]}}"
  local wallpaper_file="$DOTFILES/wallpapers/$mod_wallpaper"

  if [[ ! -f "$wallpaper_file" ]]; then
    echo "âŒ Wallpaper file not found: $wallpaper_file" >&2
    return 1
  fi

  osascript -e "tell application \"System Events\" to set picture of every desktop to \"$wallpaper_file\""
  echo "âœ“ Updated Wallpaper"
}

check_deps

if [[ -z "$DOTFILES" ]]; then
  echo "âŒ DOTFILES environment variable is not set" >&2
  exit 1
fi

available_moods=(
  "moon" \
  "storm" \
  "night" \
)

selected_mood=$(printf "%s\n" "${available_moods[@]}" | fzf --border-label="Select mood ðŸ’…ðŸ»" --height 40%)

if [[ -z "$selected_mood" ]]; then
  echo "No mood selected, exiting."
  exit 1
fi

echo "ðŸŽ¨ Applying $selected_mood mood..."

exports_file="$DOTFILES/shell/exports.sh"

if [[ ! -f "$exports_file" ]]; then
  echo "âŒ Exports file not found: $exports_file" >&2
  exit 1
fi

sed -i '' "s/^export MOOD=.*/export MOOD=\"$selected_mood\"/" "$exports_file"

# Export to current shell if sourced
if [[ "$SCRIPT_EXECUTED" == false ]]; then
  export MOOD="$selected_mood"
  echo "âœ“ Updated MOOD to: $selected_mood (exported to current shell)"
else
  echo "âœ“ Updated MOOD to: $selected_mood (saved to $exports_file)"
  echo "ðŸ’¡ To update your current shell, run: source \"$exports_file\" or restart your terminal"
fi

set_delta_mood "$selected_mood"
set_ghostty_mood "$selected_mood"
set_bat_mood "$selected_mood"
set_vscode_mood "$selected_mood"
set_zellij_mood "$selected_mood"
set_mood_wallpaper "$selected_mood"

echo "ðŸŽ‰ Successfully applied $selected_mood mood to all applications!"
